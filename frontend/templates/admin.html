<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DineManager | Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        body {
            font-family: "Poppins", sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
        }
        .sidebar {
            background: linear-gradient(180deg, #10b981, #047857);
            transition: all 0.3s ease;
        }
        .sidebar-link {
            transition: all 0.3s ease;
        }
        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
        }
        .card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #047857);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
        }
        .input-field {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        .modal-content {
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .table-slot {
            transition: all 0.3s ease;
        }
        .table-slot:hover {
            transform: scale(1.05);
        }
        .toast {
            transition: all 0.4s cubic-bezier(0.68, -0.6, 0.32, 1.6);
        }
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-gray-900 sidebar text-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out" id="sidebar">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <i class="fas fa-utensils text-2xl"></i>
                <span class="text-2xl font-bold">DineManager Admin</span>
            </div>
            <nav class="space-y-2">
                <a href="#" onclick="showAdminPage('dashboard')" class="sidebar-link flex items-center p-3 rounded-lg active">
                    <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                </a>
                <a href="#" onclick="showAdminPage('orders')" class="sidebar-link flex items-center p-3 rounded-lg">
                    <i class="fas fa-shopping-cart mr-3"></i> Orders
                </a>
                <a href="#" onclick="showAdminPage('bookings')" class="sidebar-link flex items-center p-3 rounded-lg">
                    <i class="fas fa-calendar-alt mr-3"></i> Bookings
                </a>
                <a href="#" onclick="showAdminPage('foods')" class="sidebar-link flex items-center p-3 rounded-lg">
                    <i class="fas fa-utensils mr-3"></i> Food Management
                </a>
                <a href="#" onclick="showAdminPage('events')" class="sidebar-link flex items-center p-3 rounded-lg">
                    <i class="fas fa-calendar-day mr-3"></i> Events
                </a>
                <a href="#" onclick="logout()" class="sidebar-link flex items-center p-3 rounded-lg text-red-300">
                    <i class="fas fa-sign-out-alt mr-3"></i> Logout
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="md:ml-64 p-6 min-h-screen">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
                <button id="mobile-sidebar-toggle" class="md:hidden text-gray-700">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
            <div id="admin-content" class="space-y-8"></div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-3"></div>

    <!-- Modal for Food/Event Editing -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white rounded-xl p-8 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-emerald-600" id="modal-title">Edit Item</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // Global state
        let isAdmin = false;
        const baseUrl = "http://127.0.0.1:8000/";
        const fallbackImage = "https://images.unsplash.com/photo-1513106580091-1d82408b8cd6?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=60";
        let availableTables = ["Table 1", "Table 2", "Table 3", "Table 4", "Table 5", "Table 6"];

        // Utility functions
        function generateUUID() {
            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
                const r = (Math.random() * 16) | 0,
                      v = c === "x" ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        }

        function showToast(message, type = "success") {
            const toastContainer = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast flex items-center p-4 rounded-lg shadow-lg ${
                type === "success" ? "bg-emerald-600" : "bg-red-600"
            } text-white opacity-0 transform translate-x-8`;
            toast.innerHTML = `
                <i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-circle"} mr-2"></i>
                <span>${message}</span>
            `;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove("translate-x-8");
                toast.classList.add("opacity-100");
            }, 10);

            setTimeout(() => {
                toast.classList.add("translate-x-8");
                toast.classList.remove("opacity-100");
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        async function makeRequest(url, method, body = null, requiresAuth = true) {
            const headers = {};
            if (requiresAuth && localStorage.getItem("accessToken")) {
                headers["Authorization"] = `Bearer ${localStorage.getItem("accessToken")}`;
            }

            const options = {
                method,
                headers,
            };

            if (body) {
                options.body = body;
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Something went wrong");
                }

                return data;
            } catch (error) {
                showToast(error.message || "API request failed", "error");
                throw error;
            }
        }

        // API functions
        async function loadOrders() {
            return [
                { id: 1, customer: "John Doe", items: ["Margherita Pizza"], total: 12.99, status: "Pending", type: "Delivery", address: "123 Main St" },
                { id: 2, customer: "Jane Smith", items: ["Caesar Salad", "Grilled Salmon"], total: 27.98, status: "Completed", type: "Pickup", address: "Pickup at Cafe" },
            ];
        }

        async function loadBookings() {
            return [
                { id: 1, customer: "John Doe", date: "2025-08-12", time: "6:00 PM", guests: 4, table: "Table 2", status: "Confirmed", amount: 500 },
                { id: 2, customer: "Jane Smith", date: "2025-08-13", time: "7:00 PM", guests: 2, table: "Table 4", status: "Pending", amount: 300 },
            ];
        }

        async function loadFoodItems() {
            try {
                const data = await makeRequest(`${baseUrl}foods/list/`, "GET", null, true);
                return data.map(item => ({
                    ...item,
                    image: item.image && item.image.startsWith("http") ? item.image : fallbackImage,
                    ingredients: item.ingredients || [],
                }));
            } catch (error) {
                return [];
            }
        }

        async function loadCategories() {
            try {
                const data = await makeRequest(`${baseUrl}foods/categories/`, "GET", null, true);
                return data;
            } catch (error) {
                return [];
            }
        }

        async function addCategory(name) {
            try {
                const formData = new FormData();
                formData.append("name", name);
                const data = await makeRequest(`${baseUrl}foods/categories/`, "POST", formData, true);
                showToast("Category added successfully");
                return data;
            } catch (error) {
                return null;
            }
        }

        async function addFood(foodData) {
            try {
                const formData = new FormData();
                formData.append("name", foodData.name);
                formData.append("price", foodData.price);
                formData.append("description", foodData.description);
                formData.append("ingredients", JSON.stringify(foodData.ingredients || []));
                formData.append("category_id", foodData.category_id);

                const fileInput = document.getElementById("food-image");
                if (fileInput && fileInput.files[0]) {
                    formData.append("image", fileInput.files[0]);
                }

                const data = await makeRequest(`${baseUrl}foods/list/`, "POST", formData, true);
                showToast("Food item added successfully");
                return data;
            } catch (error) {
                return null;
            }
        }

        async function updateFood(id, foodData) {
            try {
                const formData = new FormData();
                formData.append("name", foodData.name);
                formData.append("price", foodData.price);
                formData.append("description", foodData.description);
                formData.append("ingredients", JSON.stringify(foodData.ingredients || []));
                formData.append("category_id", foodData.category_id);

                const fileInput = document.getElementById("edit-food-image");
                if (fileInput && fileInput.files[0]) {
                    formData.append("image", fileInput.files[0]);
                }

                const data = await makeRequest(`${baseUrl}foods/list/${id}/`, "PUT", formData, true);
                showToast("Food item updated successfully");
                return data;
            } catch (error) {
                return null;
            }
        }

        async function deleteFood(id) {
            try {
                await makeRequest(`${baseUrl}foods/list/${id}/`, "DELETE", null, true);
                showToast("Food item deleted successfully");
                return true;
            } catch (error) {
                return false;
            }
        }

        async function addEvent(eventData) {
            try {
                const formData = new FormData();
                formData.append("name", eventData.name);
                formData.append("date", eventData.date);
                formData.append("description", eventData.description);
                formData.append("type", eventData.type);

                const fileInput = document.getElementById("event-image");
                if (fileInput && fileInput.files[0]) {
                    formData.append("image", fileInput.files[0]);
                }

                const data = await makeRequest(`${baseUrl}events/`, "POST", formData, true);
                showToast("Event added successfully");
                return data;
            } catch (error) {
                return null;
            }
        }

        async function updateEvent(id, eventData) {
            try {
                const formData = new FormData();
                formData.append("name", eventData.name);
                formData.append("date", eventData.date);
                formData.append("description", eventData.description);
                formData.append("type", eventData.type);

                const fileInput = document.getElementById("edit-event-image");
                if (fileInput && fileInput.files[0]) {
                    formData.append("image", fileInput.files[0]);
                }

                const data = await makeRequest(`${baseUrl}events/${id}/`, "PUT", formData, true);
                showToast("Event updated successfully");
                return data;
            } catch (error) {
                return null;
            }
        }

        async function deleteEvent(id) {
            try {
                await makeRequest(`${baseUrl}events/${id}/`, "DELETE", null, true);
                showToast("Event deleted successfully");
                return true;
            } catch (error) {
                return false;
            }
        }

        // Page rendering functions
        async function renderDashboardPage() {
            const orders = await loadOrders();
            const bookings = await loadBookings();
            const foods = await loadFoodItems();

            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card bg-white p-6">
                        <h3 class="text-xl font-semibold mb-4">Total Orders</h3>
                        <p class="text-3xl font-bold text-emerald-600">${orders.length}</p>
                    </div>
                    <div class="card bg-white p-6">
                        <h3 class="text-xl font-semibold mb-4">Active Bookings</h3>
                        <p class="text-3xl font-bold text-emerald-600">${bookings.length}</p>
                    </div>
                    <div class="card bg-white p-6">
                        <h3 class="text-xl font-semibold mb-4">Menu Items</h3>
                        <p class="text-3xl font-bold text-emerald-600">${foods.length}</p>
                    </div>
                </div>
                <div class="card bg-white p-6">
                    <h3 class="text-xl font-semibold mb-4">Recent Activity</h3>
                    <div class="space-y-4">
                        ${orders.slice(0, 3).map(order => `
                            <div class="flex justify-between items-center border-b pb-2">
                                <div>
                                    <p class="font-medium">${order.customer}</p>
                                    <p class="text-sm text-gray-600">${order.items.join(", ")}</p>
                                </div>
                                <span class="text-emerald-600 font-bold">$${order.total.toFixed(2)}</span>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;
        }

        async function renderOrdersPage() {
            const orders = await loadOrders();
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6">Order Management</h2>
                <div class="card bg-white p-6">
                    <div class="space-y-4">
                        ${orders.map(order => `
                            <div class="flex justify-between items-center border-b pb-4">
                                <div>
                                    <p class="font-medium">${order.customer}</p>
                                    <p class="text-sm text-gray-600">${order.items.join(", ")}</p>
                                    <p class="text-sm text-gray-500">${order.type} - ${order.address}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-emerald-600 font-bold">$${order.total.toFixed(2)}</span>
                                    <select onchange="updateOrderStatus(${order.id}, this.value)" class="border rounded-lg p-2">
                                        <option value="Pending" ${order.status === "Pending" ? "selected" : ""}>Pending</option>
                                        <option value="Processing" ${order.status === "Processing" ? "selected" : ""}>Processing</option>
                                        <option value="Completed" ${order.status === "Completed" ? "selected" : ""}>Completed</option>
                                        <option value="Cancelled" ${order.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;
        }

        async function renderBookingsPage() {
            const bookings = await loadBookings();
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6">Booking Management</h2>
                <div class="card bg-white p-6">
                    <h3 class="text-lg font-semibold mb-4">Available Tables</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                        ${availableTables.map(table => `
                            <div class="table-slot p-4 text-center rounded-lg border-2 border-gray-200 bg-white hover:border-emerald-300">
                                <i class="fas fa-chair text-2xl text-gray-400 mb-2"></i>
                                <p class="font-medium">${table}</p>
                            </div>
                        `).join("")}
                    </div>
                    <h3 class="text-lg font-semibold mb-4">Current Bookings</h3>
                    <div class="space-y-4">
                        ${bookings.map(booking => `
                            <div class="flex justify-between items-center border-b pb-4">
                                <div>
                                    <p class="font-medium">${booking.customer}</p>
                                    <p class="text-sm text-gray-600">${booking.date} at ${booking.time}</p>
                                    <p class="text-sm text-gray-500">${booking.guests} Guests, ${booking.table}</p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-emerald-600 font-bold">Rs. ${booking.amount}</span>
                                    <select onchange="updateBookingStatus(${booking.id}, this.value)" class="border rounded-lg p-2">
                                        <option value="Pending" ${booking.status === "Pending" ? "selected" : ""}>Pending</option>
                                        <option value="Confirmed" ${booking.status === "Confirmed" ? "selected" : ""}>Confirmed</option>
                                        <option value="Cancelled" ${booking.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;
        }

        async function renderFoodsPage() {
            const foods = await loadFoodItems();
            const categories = await loadCategories();
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6">Food Management</h2>
                <div class="card bg-white p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Add New Food Item</h3>
                    <div class="space-y-4">
                        <input id="food-name" type="text" placeholder="Dish Name" class="input-field w-full p-3 rounded-lg border" />
                        <input id="food-price" type="number" placeholder="Price ($)" step="0.01" class="input-field w-full p-3 rounded-lg border" />
                        <textarea id="food-description" placeholder="Description" rows="3" class="input-field w-full p-3 rounded-lg border"></textarea>
                        <input id="food-ingredients" type="text" placeholder="Ingredients (comma separated)" class="input-field w-full p-3 rounded-lg border" />
                        <select id="food-category" class="input-field w-full p-3 rounded-lg border">
                            <option value="">Select Category</option>
                            ${categories.map(category => `<option value="${category.id}">${category.name}</option>`).join("")}
                        </select>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">Drag & drop image or click to browse</p>
                            <input type="file" id="food-image" accept="image/*" class="hidden" />
                            <img id="food-image-preview" class="image-preview mx-auto" src="" alt="Image Preview" />
                        </div>
                        <button onclick="submitFood()" class="btn-primary text-white py-3 rounded-lg w-full">Add Food Item</button>
                    </div>
                </div>
                <div class="card bg-white p-6">
                    <h3 class="text-lg font-semibold mb-4">Menu Items</h3>
                    <div class="space-y-4">
                        ${foods.map(food => `
                            <div class="flex justify-between items-center border-b pb-4">
                                <div class="flex items-center">
                                    <img src="${food.image}" alt="${food.name}" class="w-16 h-16 rounded-lg object-cover mr-4" onerror="this.src='${fallbackImage}'" />
                                    <div>
                                        <p class="font-medium">${food.name}</p>
                                        <p class="text-sm text-gray-600">${food.description}</p>
                                        <p class="text-sm text-gray-500">${food.category.name}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-emerald-600 font-bold">$${food.price.toFixed(2)}</span>
                                    <button onclick="editFood('${food.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteFoodItem('${food.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;
            // Image picker event listener
            const fileInputContainer = document.querySelector(".border-dashed");
            const fileInput = document.getElementById("food-image");
            const preview = document.getElementById("food-image-preview");
            fileInputContainer.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", () => {
                if (fileInput.files[0]) {
                    preview.src = URL.createObjectURL(fileInput.files[0]);
                    preview.style.display = "block";
                } else {
                    preview.style.display = "none";
                }
            });
        }

        async function renderEventsPage() {
            const events = [
                { id: "1", name: "Live Music Night", date: "2025-08-12", description: "Enjoy live jazz with local artists!", type: "current", image: fallbackImage },
                { id: "2", name: "Coffee Tasting Workshop", date: "2025-08-20", description: "Learn about coffee origins.", type: "upcoming", image: fallbackImage },
            ];
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6">Event Management</h2>
                <div class="card bg-white p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Add New Event</h3>
                    <div class="space-y-4">
                        <input id="event-name" type="text" placeholder="Event Name" class="input-field w-full p-3 rounded-lg border" />
                        <input id="event-date" type="date" class="input-field w-full p-3 rounded-lg border" />
                        <textarea id="event-description" placeholder="Description" rows="3" class="input-field w-full p-3 rounded-lg border"></textarea>
                        <select id="event-type" class="input-field w-full p-3 rounded-lg border">
                            <option value="current">Current</option>
                            <option value="upcoming">Upcoming</option>
                        </select>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-500">Drag & drop image or click to browse</p>
                            <input type="file" id="event-image" accept="image/*" class="hidden" />
                            <img id="event-image-preview" class="image-preview mx-auto" src="" alt="Image Preview" />
                        </div>
                        <button onclick="submitEvent()" class="btn-primary text-white py-3 rounded-lg w-full">Add Event</button>
                    </div>
                </div>
                <div class="card bg-white p-6">
                    <h3 class="text-lg font-semibold mb-4">Events</h3>
                    <div class="space-y-4">
                        ${events.map(event => `
                            <div class="flex justify-between items-center border-b pb-4">
                                <div class="flex items-center">
                                    <img src="${event.image}" alt="${event.name}" class="w-16 h-16 rounded-lg object-cover mr-4" onerror="this.src='${fallbackImage}'" />
                                    <div>
                                        <p class="font-medium">${event.name}</p>
                                        <p class="text-sm text-gray-600">${event.description}</p>
                                        <p class="text-sm text-gray-500">${event.date} - ${event.type}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <button onclick="editEvent('${event.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteEvent('${event.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;
            // Image picker event listener
            const fileInputContainer = document.querySelector(".border-dashed");
            const fileInput = document.getElementById("event-image");
            const preview = document.getElementById("event-image-preview");
            fileInputContainer.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", () => {
                if (fileInput.files[0]) {
                    preview.src = URL.createObjectURL(fileInput.files[0]);
                    preview.style.display = "block";
                } else {
                    preview.style.display = "none";
                }
            });
        }

        // Helper functions
        async function submitFood() {
            const name = document.getElementById("food-name").value;
            const price = document.getElementById("food-price").value;
            const description = document.getElementById("food-description").value;
            const ingredients = document.getElementById("food-ingredients").value.split(",").map(item => item.trim()).filter(item => item);
            const category_id = document.getElementById("food-category").value;

            if (!name || !price || !description || !category_id) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            const parsedPrice = parseFloat(price);
            if (isNaN(parsedPrice) || parsedPrice <= 0) {
                showToast("Please enter a valid price", "error");
                return;
            }

            const categories = await loadCategories();
            if (!categories.find(cat => cat.id === parseInt(category_id))) {
                showToast("Invalid category selected", "error");
                return;
            }

            const foodData = { name, price: parsedPrice, description, ingredients, category_id: parseInt(category_id) };
            const result = await addFood(foodData);
            if (result) {
                document.getElementById("food-name").value = "";
                document.getElementById("food-price").value = "";
                document.getElementById("food-description").value = "";
                document.getElementById("food-ingredients").value = "";
                document.getElementById("food-image").value = "";
                document.getElementById("food-image-preview").style.display = "none";
                renderFoodsPage();
            }
        }

        async function editFood(id) {
            const foods = await loadFoodItems();
            const food = foods.find(item => item.id === id);
            if (!food) return;

            const categories = await loadCategories();
            document.getElementById("modal-title").textContent = "Edit Food Item";
            document.getElementById("modal-content").innerHTML = `
                <div class="space-y-4">
                    <input id="edit-food-name" type="text" value="${food.name}" placeholder="Dish Name" class="input-field w-full p-3 rounded-lg border" />
                    <input id="edit-food-price" type="number" value="${food.price}" placeholder="Price ($)" step="0.01" class="input-field w-full p-3 rounded-lg border" />
                    <textarea id="edit-food-description" placeholder="Description" rows="3" class="input-field w-full p-3 rounded-lg border">${food.description}</textarea>
                    <input id="edit-food-ingredients" type="text" value="${food.ingredients.join(", ")}" placeholder="Ingredients (comma separated)" class="input-field w-full p-3 rounded-lg border" />
                    <select id="edit-food-category" class="input-field w-full p-3 rounded-lg border">
                        <option value="">Select Category</option>
                        ${categories.map(category => `<option value="${category.id}" ${category.id === food.category.id ? "selected" : ""}>${category.name}</option>`).join("")}
                    </select>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">Drag & drop image or click to browse</p>
                        <input type="file" id="edit-food-image" accept="image/*" class="hidden" />
                        <img id="edit-food-image-preview" class="image-preview mx-auto" src="${food.image}" alt="Image Preview" style="display: ${food.image ? 'block' : 'none'};" />
                    </div>
                    <button onclick="submitEditFood('${id}')" class="btn-primary text-white py-3 rounded-lg w-full">Save Changes</button>
                </div>
            `;
            document.getElementById("edit-modal").classList.remove("hidden");
            const fileInputContainer = document.querySelector(".modal-content .border-dashed");
            const fileInput = document.getElementById("edit-food-image");
            const preview = document.getElementById("edit-food-image-preview");
            fileInputContainer.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", () => {
                if (fileInput.files[0]) {
                    preview.src = URL.createObjectURL(fileInput.files[0]);
                    preview.style.display = "block";
                }
            });
        }

        async function submitEditFood(id) {
            const name = document.getElementById("edit-food-name").value;
            const price = document.getElementById("edit-food-price").value;
            const description = document.getElementById("edit-food-description").value;
            const ingredients = document.getElementById("edit-food-ingredients").value.split(",").map(item => item.trim()).filter(item => item);
            const category_id = document.getElementById("edit-food-category").value;

            if (!name || !price || !description || !category_id) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            const parsedPrice = parseFloat(price);
            if (isNaN(parsedPrice) || parsedPrice <= 0) {
                showToast("Please enter a valid price", "error");
                return;
            }

            const categories = await loadCategories();
            if (!categories.find(cat => cat.id === parseInt(category_id))) {
                showToast("Invalid category selected", "error");
                return;
            }

            const foodData = { name, price: parsedPrice, description, ingredients, category_id: parseInt(category_id) };
            const result = await updateFood(id, foodData);
            if (result) {
                closeModal();
                renderFoodsPage();
            }
        }

        async function deleteFoodItem(id) {
            if (confirm("Are you sure you want to delete this food item?")) {
                const result = await deleteFood(id);
                if (result) renderFoodsPage();
            }
        }

        async function submitEvent() {
            const name = document.getElementById("event-name").value;
            const date = document.getElementById("event-date").value;
            const description = document.getElementById("event-description").value;
            const type = document.getElementById("event-type").value;

            if (!name || !date || !description || !type) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            const eventData = { name, date, description, type };
            const result = await addEvent(eventData);
            if (result) {
                document.getElementById("event-name").value = "";
                document.getElementById("event-date").value = "";
                document.getElementById("event-description").value = "";
                document.getElementById("event-type").value = "current";
                document.getElementById("event-image").value = "";
                document.getElementById("event-image-preview").style.display = "none";
                renderEventsPage();
            }
        }

        async function editEvent(id) {
            const events = [
                { id: "1", name: "Live Music Night", date: "2025-08-12", description: "Enjoy live jazz with local artists!", type: "current", image: fallbackImage },
                { id: "2", name: "Coffee Tasting Workshop", date: "2025-08-20", description: "Learn about coffee origins.", type: "upcoming", image: fallbackImage },
            ];
            const event = events.find(e => e.id === id);
            if (!event) return;

            document.getElementById("modal-title").textContent = "Edit Event";
            document.getElementById("modal-content").innerHTML = `
                <div class="space-y-4">
                    <input id="edit-event-name" type="text" value="${event.name}" placeholder="Event Name" class="input-field w-full p-3 rounded-lg border" />
                    <input id="edit-event-date" type="date" value="${event.date}" class="input-field w-full p-3 rounded-lg border" />
                    <textarea id="edit-event-description" placeholder="Description" rows="3" class="input-field w-full p-3 rounded-lg border">${event.description}</textarea>
                    <select id="edit-event-type" class="input-field w-full p-3 rounded-lg border">
                        <option value="current" ${event.type === "current" ? "selected" : ""}>Current</option>
                        <option value="upcoming" ${event.type === "upcoming" ? "selected" : ""}>Upcoming</option>
                    </select>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">Drag & drop image or click to browse</p>
                        <input type="file" id="edit-event-image" accept="image/*" class="hidden" />
                        <img id="edit-event-image-preview" class="image-preview mx-auto" src="${event.image}" alt="Image Preview" style="display: ${event.image ? 'block' : 'none'};" />
                    </div>
                    <button onclick="submitEditEvent('${id}')" class="btn-primary text-white py-3 rounded-lg w-full">Save Changes</button>
                </div>
            `;
            document.getElementById("edit-modal").classList.remove("hidden");
            const fileInputContainer = document.querySelector(".modal-content .border-dashed");
            const fileInput = document.getElementById("edit-event-image");
            const preview = document.getElementById("edit-event-image-preview");
            fileInputContainer.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", () => {
                if (fileInput.files[0]) {
                    preview.src = URL.createObjectURL(fileInput.files[0]);
                    preview.style.display = "block";
                }
            });
        }

        async function submitEditEvent(id) {
            const name = document.getElementById("edit-event-name").value;
            const date = document.getElementById("edit-event-date").value;
            const description = document.getElementById("edit-event-description").value;
            const type = document.getElementById("edit-event-type").value;

            if (!name || !date || !description || !type) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            const eventData = { name, date, description, type };
            const result = await updateEvent(id, eventData);
            if (result) {
                closeModal();
                renderEventsPage();
            }
        }

        async function deleteEvent(id) {
            if (confirm("Are you sure you want to delete this event?")) {
                const result = await deleteEvent(id);
                if (result) renderEventsPage();
            }
        }

        function updateOrderStatus(orderId, status) {
            showToast(`Order ${orderId} status updated to ${status}`);
            renderOrdersPage();
        }

        function updateBookingStatus(bookingId, status) {
            showToast(`Booking ${bookingId} status updated to ${status}`);
            if (status === "Cancelled") {
                const bookings = [
                    { id: 1, customer: "John Doe", date: "2025-08-12", time: "6:00 PM", guests: 4, table: "Table 2", status: "Confirmed", amount: 500 },
                    { id: 2, customer: "Jane Smith", date: "2025-08-13", time: "7:00 PM", guests: 2, table: "Table 4", status: "Pending", amount: 300 },
                ];
                const booking = bookings.find(b => b.id === bookingId);
                if (booking && !availableTables.includes(booking.table)) {
                    availableTables.push(booking.table);
                    availableTables.sort();
                }
            }
            renderBookingsPage();
        }

        function closeModal() {
            document.getElementById("edit-modal").classList.add("hidden");
        }

        function checkAuthState() {
            const userData = JSON.parse(localStorage.getItem("userData") || "null");
            if (userData && (userData.staff || userData.superuser)) {
                isAdmin = true;
            } else {
                showToast("Admin access required", "error");
                window.location.href = "signin.html";
            }
        }

        function logout() {
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            localStorage.removeItem("userData");
            isAdmin = false;
            showToast("Logged out successfully");
            window.location.href = "signin.html";
        }

        function showAdminPage(page) {
            if (!isAdmin) {
                showToast("Admin access required", "error");
                return;
            }

            document.querySelectorAll(".sidebar-link").forEach(link => {
                link.classList.toggle("active", link.getAttribute("onclick") === `showAdminPage('${page}')`);
            });

            switch (page) {
                case "dashboard":
                    renderDashboardPage();
                    break;
                case "orders":
                    renderOrdersPage();
                    break;
                case "bookings":
                    renderBookingsPage();
                    break;
                case "foods":
                    renderFoodsPage();
                    break;
                case "events":
                    renderEventsPage();
                    break;
            }
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", function() {
            checkAuthState();
            if (isAdmin) {
                showAdminPage("dashboard");
                document.getElementById("mobile-sidebar-toggle").addEventListener("click", function() {
                    document.getElementById("sidebar").classList.toggle("-translate-x-full");
                });
            }
        });
    </script>
</body>
</html>